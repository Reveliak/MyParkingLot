<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liberar Plaza - MyParkingLot</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="app-header">
            <div class="logo">
                <div class="logo-icon">P</div>
                <h1>MyParkingLot</h1>
            </div>
            <div class="user-info">
                <span id="userGreeting">Usuario</span>
                <button class="btn-link" onclick="volverDashboard()">‚Üê Volver</button>
            </div>
        </header>

        <!-- Pantalla de liberaci√≥n -->
        <main class="liberar-container">
            <h2>Liberar mi Plaza de Estacionamiento</h2>

            <div class="liberar-content">
                <!-- Informaci√≥n de la plaza asignada -->
                <div class="plaza-info-card">
                    <div class="plaza-icon">üÖøÔ∏è</div>
                    <div class="plaza-details">
                        <h3>Tu plaza asignada</h3>
                        <p class="plaza-numero-grande">#18</p>
                        <p class="plaza-tipo">Plaza fija por seniority</p>
                    </div>
                </div>

                <!-- Mensaje colaborativo -->
                <div class="mensaje-colaborativo">
                    <div class="icono-colaboracion">ü§ù</div>
                    <h3>¬øHoy no vas a utilizar tu plaza?</h3>
                    <p>Si hoy trabaj√°s desde casa o no vas a necesitar tu plaza asignada, pod√©s liberarla temporalmente para que otro compa√±ero la aproveche.</p>

                    <div class="beneficios-liberacion">
                        <p><strong>Al liberar tu plaza:</strong></p>
                        <ul>
                            <li>‚úÖ Ayud√°s a un compa√±ero que la necesita</li>
                            <li>‚úÖ Optimiz√°s el uso del recurso</li>
                            <li>‚úÖ Contribu√≠s al equipo</li>
                            <li>‚úÖ Tu plaza vuelve a estar disponible ma√±ana</li>
                        </ul>
                    </div>
                </div>

                <!-- Estado de lista de espera -->
                <div class="info-box">
                    <p><strong>üìã Usuarios en lista de espera:</strong></p>
                    <p id="listaEsperaInfo">Cargando...</p>
                </div>

                <!-- Formulario de liberaci√≥n -->
                <form id="liberarForm" class="liberar-form">
                    <div class="form-group">
                        <label>¬øEn qu√© horario vas a liberar tu plaza?</label>

                        <div class="opciones-horario">
                            <label class="radio-card">
                                <input
                                    type="radio"
                                    name="horarioLiberacion"
                                    value="todo"
                                    checked
                                >
                                <div class="radio-content">
                                    <strong>Todo el d√≠a</strong>
                                    <span>(08:00 - 18:00)</span>
                                </div>
                            </label>

                            <label class="radio-card">
                                <input
                                    type="radio"
                                    name="horarioLiberacion"
                                    value="manana"
                                >
                                <div class="radio-content">
                                    <strong>Solo ma√±ana</strong>
                                    <span>(08:00 - 14:00)</span>
                                </div>
                            </label>

                            <label class="radio-card">
                                <input
                                    type="radio"
                                    name="horarioLiberacion"
                                    value="tarde"
                                >
                                <div class="radio-content">
                                    <strong>Solo tarde</strong>
                                    <span>(14:00 - 18:00)</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="form-actions">
                        <button
                            type="button"
                            class="btn btn-secondary"
                            onclick="volverDashboard()"
                        >
                            Cancelar
                        </button>

                        <button
                            type="submit"
                            class="btn btn-primary"
                            id="btnLiberar"
                        >
                            S√ç, LIBERAR PLAZA HOY
                        </button>
                    </div>
                </form>

                <!-- Mensaje de agradecimiento -->
                <div class="agradecimiento" id="mensajeGracias" style="display: none;">
                    <div class="icono-exito">‚úÖ</div>
                    <h3>¬°Gracias por colaborar!</h3>
                    <p>Tu plaza ha sido liberada y est√° disponible para otros empleados.</p>
                    <p>El sistema notific√≥ autom√°ticamente a los usuarios en lista de espera.</p>

                    <button class="btn btn-primary" onclick="volverDashboard()">
                        VOLVER AL INICIO
                    </button>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <p>MyParkingLot - Prototipo Low-Fidelity</p>
        </footer>
    </div>

    <!-- Scripts -->
    <script src="js/data.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/app.js"></script>

    <script>
        // Inicializar al cargar la p√°gina
        window.addEventListener('DOMContentLoaded', function() {
            inicializarLiberacion();
        });

        function inicializarLiberacion() {
            // Verificar autenticaci√≥n
            const userName = sessionStorage.getItem('userName');
            const userType = sessionStorage.getItem('userType');

            if (!userName) {
                window.location.href = 'index.html';
                return;
            }

            // Verificar que sea usuario con plaza fija
            if (userType !== 'fixed') {
                alert('Esta funci√≥n es solo para usuarios con plaza asignada');
                window.location.href = 'dashboard.html';
                return;
            }

            document.getElementById('userGreeting').textContent = userName;

            // Cargar informaci√≥n de lista de espera
            cargarListaEspera();

            // Listener del formulario
            document.getElementById('liberarForm').addEventListener('submit', confirmarLiberacion);
        }

        function cargarListaEspera() {
            const listaEsperaInfo = document.getElementById('listaEsperaInfo');
            const listaEspera = window.MOCK_DATA.listaEspera;

            if (listaEspera.length === 0) {
                listaEsperaInfo.innerHTML = '<em>No hay usuarios en lista de espera en este momento</em>';
            } else {
                let html = `<strong>${listaEspera.length} ${listaEspera.length === 1 ? 'persona' : 'personas'} esperando:</strong><br>`;
                listaEspera.slice(0, 3).forEach((item, index) => {
                    html += `${index + 1}. ${item.usuarioNombre} - ${item.horario}<br>`;
                });

                if (listaEspera.length > 3) {
                    html += `<em>...y ${listaEspera.length - 3} m√°s</em>`;
                }

                listaEsperaInfo.innerHTML = html;
            }
        }

        function confirmarLiberacion(e) {
            e.preventDefault();

            const horarioSeleccionado = document.querySelector('input[name="horarioLiberacion"]:checked').value;
            const userName = sessionStorage.getItem('userName');

            let horarioTexto = '';
            switch(horarioSeleccionado) {
                case 'todo':
                    horarioTexto = 'todo el d√≠a (08:00-18:00)';
                    break;
                case 'manana':
                    horarioTexto = 'la ma√±ana (08:00-14:00)';
                    break;
                case 'tarde':
                    horarioTexto = 'la tarde (14:00-18:00)';
                    break;
            }

            // Confirmaci√≥n
            const confirmacion = confirm(
                `¬øConfirmas que quer√©s liberar tu plaza #18 para ${horarioTexto}?\n\n` +
                `El sistema notificar√° autom√°ticamente a los usuarios en lista de espera.`
            );

            if (!confirmacion) return;

            // Simular liberaci√≥n
            window.actualizarEstadoPlaza(18, 'libre', null);

            // Notificar al pr√≥ximo en espera
            const proximoNotificado = window.notificarProximoEnEspera();

            if (proximoNotificado) {
                console.log(`üì± Notificaci√≥n enviada a: ${proximoNotificado.usuarioNombre}`);
            }

            // Guardar evento de liberaci√≥n
            const liberacion = {
                plazaId: 18,
                usuario: userName,
                horario: horarioTexto,
                fecha: window.getFechaActual(),
                timestamp: new Date().getTime()
            };

            localStorage.setItem('ultimaLiberacion', JSON.stringify(liberacion));

            // Ocultar formulario y mostrar agradecimiento
            document.getElementById('liberarForm').style.display = 'none';
            document.querySelector('.plaza-info-card').style.display = 'none';
            document.querySelector('.mensaje-colaborativo').style.display = 'none';
            document.querySelector('.info-box').style.display = 'none';
            document.getElementById('mensajeGracias').style.display = 'block';

            // Mostrar notificaci√≥n
            window.mostrarNotificacion('‚úÖ Plaza liberada exitosamente', 'success');
        }

        function volverDashboard() {
            window.location.href = 'dashboard.html';
        }
    </script>
</body>
</html>
